<div class="content" th:unless="${#lists.isEmpty(deliverable)}">
    <formfield>
        <legend>Basic info</legend>
        <div th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.SeriesDeliverable)}" th:text="@{|Delivery position: ${deliverable.deliveryDaysAfterSubscription}|}"></div>
        <div th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.ScheduledDeliverable)}" th:text="@{|Delivery date: ${deliverable.getDeliveryDateString()}|}"></div>
        <a th:href="${deliverable.content.getContentUrl()}" target='_blank'>Link</a>
    </formfield>
    <formfield>
        <legend>Content</legend>
        <form name="content-form" class="pure-form pure-form-stacked" action="#" th:action="@{|/deliverypipe/${deliveryPipeId}/${deliverable.type.name().toLowerCase()}|}"
              method="post">
            <div class="form-fields">
                <div th:if="${error}" class="alert alert-error" th:text="#{deliverable.error}">
                    Error in content data.
                </div>
                <div th:if="${saved}" class="alert alert-success" th:text="#{deliverable.saved}">
                    Content saved.
                </div>
                <input type="hidden" name="id" th:value="${deliverable.id}"/>

                <input type="hidden" th:name="content.id" th:value="${deliverable.content.id}"/>
                <input type="hidden" th:name="status" th:value="${deliverable.status}"/>

                <!-- TODO: content in view mode if status == APPROVED -->

                <label for="content.title" th:text="#{content.title}">Title</label>
                <input type="text" required="true" name="content.title" th:value="${deliverable.content.title}"/>

                <label for="content.message" th:text="#{content.message}">Title</label>
                <textarea required="true" name="content.message" th:text="${deliverable.content.message}" maxlength="140" cols="30" row="6"/>
                <span class="message-preview"><span class="message" th:text="@{|${deliverable.content.message}|}"></span><br/><span class="url" th:text="${deliverable.content.getContentUrl()}"></span></span>

                <label for="content.content" th:text="#{content.content}">Content</label>
                <textarea required="true" name="content.content" th:text="${deliverable.content.content}"/>

                <input type="hidden" th:name="save" />
                <input th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.SeriesDeliverable)}" type="hidden" th:name="deliveryDaysAfterSubscription" th:value="${deliverable.deliveryDaysAfterSubscription}"/>
                <input th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.ScheduledDeliverable)}" type="hidden" th:name="deliveryDate" th:field="${deliverable.deliveryDateString}"/>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            </div>
            <div class="form-actions">
                <a class="submit" th:text="#{general.save}">Save</a>
                <a class="cancel" th:text="#{general.cancel}">Cancel</a>
            </div>
        </form>
    </formfield>
    <div id="previewers">
        <div class="iphone-previewer">
            <div class="previewer-content" th:utext="${deliverable.content.content}"></div>
        </div>
        <div class="ipad-previewer">
            <div class="previewer-content" th:utext="${deliverable.content.content}"></div>
        </div>
    </div>
    <script  th:inline="javascript">
        $("select[name='providers']").multiSelect();
        $("textarea[name='content.content']").summernote({
            onChange: function (e) {
                $(".previewer-content").html($("textarea[name='content.content']").code());
            }
        });
        $("input[name='content.title']").change(function() {
            if(!$("textarea[name='content.message']").val()) {
                $("textarea[name='content.message']").val($(this).val() + "\n\nClick for more");
            }
        });
        $("textarea[name='content.message']").change(function() {
            $(".message-preview .message").html($(this).val().replace("\n", "<br/>"));
        });
        $(".submit").click(function() {
            var deliveryPipeContentListUrl = /*[[@{|/deliverypipe/${deliveryPipeId}/content/list|}]]*/;
            var form = $(this).parents('form');
            mContent.ajax.submit(form,
                function(data) {
                    mContent.notify("Changes stored", "info");
                    mContent.loaders.workArea(deliveryPipeContentListUrl);
                }, function(error) {
                    console.log(error);
                    mContent.notify("Failed to save the cahnges", "error");
                }
            );
        })
        $(".cancel").click(function() {
            $('#content-editor').html( "" );
        })
    </script>
</div>