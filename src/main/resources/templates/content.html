<div class="content" th:unless="${#lists.isEmpty(deliverable)}">


    <script th:src="@{|/lib/dropzone/dropzone.min.js|}" th:if="${autoGenerateContent and deliverable.id != null and deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"></script>
    <formfield>
        <legend>Basic info</legend>
        <div th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.SeriesDeliverable)}" th:text="@{|Delivery position: ${deliverable.deliveryDaysAfterSubscription}|}"></div>
        <div th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.ScheduledDeliverable)}" th:text="@{|Delivery date: ${deliverable.getDeliveryDateString()}|}"></div>
        <a th:href="${deliverable.content.getContentUrl()}" target='_blank'>Link</a>
    </formfield>
    <formfield>
        <legend>Content</legend>
        <form th:id="${deliverable.id?: '0'} + '-content-form'" name="content-form" class="pure-form pure-form-stacked" action="#"
              th:action="@{/deliverypipe/} + ${deliveryPipeId} + '/' + ${deliverable.type.name().toLowerCase()} + '/' + ${deliverable.id?: '0'}"
              method="post" enctype="multipart/form-data" >
            <div class="form-fields">
                <div th:if="${error}" class="alert alert-error" th:text="#{deliverable.error}">
                    Error in content data.
                </div>
                <div th:if="${saved}" class="alert alert-success" th:text="#{deliverable.saved}">
                    Content saved.
                </div>
                <input type="hidden" name="id" th:value="${deliverable.id}"/>

                <input type="hidden" th:name="content.id" th:value="${deliverable.content.id}"/>
                <input type="hidden" th:name="status" th:value="${deliverable.status}"/>
                <input type="hidden" th:name="autoGenerateContent" th:value="${autoGenerateContent}"/>
                <input type="hidden" th:name="fileUpload" th:value="${fileUpload}"/>

                <label for="content.title" th:text="#{content.title}">Title</label>
                <input type="text"
                       th:if="${deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                       required="true" name="content.title" th:value="${deliverable.content.title}"/>
                <input type="text"
                       th:if="${deliverable.status == T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                       required="false" readonly="true" name="content.title" th:value="${deliverable.content.title}"/>

                <label for="content.message" th:text="#{content.message}">Title</label>
                <textarea required="true"
                          th:if="${deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                          name="content.message" th:text="${deliverable.content.message}" maxlength="140" cols="30" row="6"/>
                <textarea required="false" readonly="true" 
                          th:if="${deliverable.status == T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                          name="content.message" th:text="${deliverable.content.message}" maxlength="140" cols="30" row="6"/>

                <!--    File Upload option -->
                <div id="my-dropzone" th:if="${autoGenerateContent and deliverable.id != null and deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}">
                    <label th:text="#{contentfiles.files}">Files</label>
                    <table id="file-table" class="pure-table">
                        <tr style="display: none" > <!-- 1st row as header for later addition of rows to table from JavaScript -->
                            <td>Image</td>
                            <td>File</td>
                            <td/>
                        </tr>
                        <tr th:each="contentFile : ${deliverable.files}">
                            <td>
                                <img class="content-thumb-image" th:src="|data:image/png;base64,${contentFile.thumbBase64Png}|" />
                            </td>
                            <td th:text="${contentFile.originalFilename}">NAME</td>
                            <td>
                                <div>
                                    <a class="remove-content-file pure-button" sec:authorize="hasRole('ADMIN')"
                                       th:href="${contentFile.uuid}"
                                       th:text="#{general.remove}" >Remove</a>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <br/>
                    <label th:text="#{contentfiles.dropzone.tip}">Drop new files here or click this area</label>
                    <div id="dropzone-previews" class="dropzone-previews dropzone dz-clickable dz-default dz-message">
                        <div class="fallback">
                            <input type="file" name="file" multiple="multiple"/>
                        </div>
                    </div>
                </div>

                <span class="message-preview">
                    <span class="message" th:text="@{|${deliverable.content.message}|}"></span>
                    <br/>
                    <span class="url" th:text="${deliverable.content.getContentUrl()}"></span>
                </span>

                <div th:if="${!autoGenerateContent and deliverable.id != null}" >
                    <label for="content.content" th:text="#{content.content}">Content</label>
                    <textarea required="true"
                              th:if="${deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                              name="content.content" th:text="${deliverable.content.content}"/>
                    <textarea required="false" readonly="true"
                              th:if="${deliverable.status == T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                              name="content.content" th:text="${deliverable.content.content}"/>
                </div>
                <div th:if="${autoGenerateContent or deliverable.id == null}" >
                    <textarea required="false" style ="display: none;"
                              name="content.content" th:text="${deliverable.content.content}"/>
                </div>

                <input type="hidden" th:name="save" />
                <input th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.SeriesDeliverable)}" type="hidden" th:name="deliveryDaysAfterSubscription" th:value="${deliverable.deliveryDaysAfterSubscription}"/>
                <input th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.ScheduledDeliverable)}" type="hidden" th:name="deliveryDate" th:field="${deliverable.deliveryDateString}"/>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            </div>
            <br/>
            <div class="form-actions">
                <a class="content-submit pure-button"
                   th:if="${deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                   th:text="#{general.save}">Save</a>
                <a class="content-cancel pure-button" th:text="#{general.cancel}">Cancel</a>
            </div>
        </form>
    </formfield>
    <div id="previewers">
        <div class="iphone-previewer">
            <div class="previewer-content" th:utext="${deliverable.content.content}"></div>
        </div>
        <div class="ipad-previewer">
            <div class="previewer-content" th:utext="${deliverable.content.content}"></div>
        </div>
    </div>

    <script th:inline="javascript" th:if="${autoGenerateContent and deliverable.id != null and deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}">
        /*<![CDATA[*/

        var fileDropzone = new Dropzone("div#my-dropzone", {
            url: /*[[@{'/fileupload'}]]*/ "/fileupload",
            autoProcessQueue: true,
            uploadMultiple: false, // Multiple ei toimi kunnolla virhetilanteessa, koska flagaa kaikki virheellisiksi
            createImageThumbnails: true,
            parallelUploads: 20,
            maxFiles: 20,
            maxFilesize: 2, // Max file size 2MB
            filesizeBase: 1024,
            acceptedFiles: 'image/*',
            previewsContainer: '#dropzone-previews',
            init: function () {
                var myDropzone = this;

                 this.on("addedfile", function (file) {
                    // Check for duplicates
                    var _file, _i, _len, _ref, _result;
                    _ref = myDropzone.files;
                    _result = 0;
                    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                        _file = _ref[_i];
                        if ((_file.name === file.name) && (_file.size === file.size)) {
                            _result++;
                        }
                    }
                    if (_result > 1) {  // No duplicates, thank you
                        myDropzone.removeFile(file);
                        mContent.notify("Can not add file ("+file.name+")\nFile is allready uploaded", "error");
                    }
                });

                this.on("success", function (file, response) {
                    if (/*[[${#authorization.expression('hasRole(''ADMIN'')')}]]*/ == true){
                        var _href = file.uuid;
                        var _text =  /*[[#{general.remove}]]*/ "Remove";
                        var newrow = $('#file-table tr:last').after( "<tr><td><img src='data:image/png;base64,"+response.files[0].thumbBase64Png+"' alt='"+file.name+"' /></td><td>"+file.name+
                                "</td><td>Not saved</td></tr>");
                        var originalHtml = $(".previewer-content").first().html();  // update previewers
                        $(".previewer-content").html(originalHtml+response.files[0].imageHtmlBlock);
                        addNewFile(response.files[0]);
                    }
                });

                this.on("error", function (file, response, xhr) {
                    var _filename = file.name;
                    mContent.notify("Error on uploading file "+_filename+"\nResponse message: "+response.message ,"error");
                    var removeButton = Dropzone.createElement("<button>Clear</button>");
                    var _this = this;
                    removeButton.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        // Remove the file preview.
                        _this.removeFile(file);
                    });
                    file.previewElement.appendChild(removeButton);
                });

                this.on("sending", function(file, xhr, formData) {
                    formData.append("_csrf", /*[[${_csrf.token}]]*/ "");
                });
            }
        });

        /*]]>*/
    </script>

    <script th:inline="javascript" th:if="${!autoGenerateContent and deliverable.id != null and deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}">
        /*<![CDATA[*/

        $("textarea[name='content.content']").summernote({
            callbacks: {
                onMediaDelete : function(target, editor) {
                    addRemovedFile(target[0].id);
                    target.remove();
                },
                onImageUpload: function(files) {
                    var _i, _len;
                    for (_i = 0, _len = files.length; _i < _len; _i++) {
                        sendFile(files[_i]);
                    }
                },
                onImageUploadError: function(err){
                    alert('Upload error : '+err);
                },
                onChange: function (e) {
                    $(".previewer-content").html($("textarea[name='content.content']").val());
                }
            }
        });

        function sendFile(file) {
            data = new FormData();
            data.append("file", file);
            data.append("_csrf", /*[[${_csrf.token}]]*/ "");
            $.ajax({
                data: data,
                type: "POST",
                url: /*[[@{'/fileupload'}]]*/ "/fileupload",
                cache: false,
                contentType: false,
                processData: false,
                success: function(response, status, xhr) {
                    $("textarea[name='content.content']").summernote('code', $("textarea[name='content.content']").val() + response.files[0].imageHtmlBlock);
                    addNewFile(response.files[0]);
                }
            });
        }

        /*]]>*/
    </script>

    <script th:inline="javascript" >
        /*<![CDATA[*/
        var newFiles = new Array();
        var removedFiles = new Array();
        var thisForm = $(/*[['#'+ ${deliverable.id?: '0'} + '-content-form']]*/);

        function addNewFile(file) {
            newFiles.push(file.uuid);
        }

        function addRemovedFile(uuid) {
            removedFiles.push(uuid);
        }

        $("input[name='content.title']").change(function() {
            if(!$("textarea[name='content.message']").val()) {
                $("textarea[name='content.message']").val($(this).val() + "\n\nClick for more");
            }
        });
        
        $("textarea[name='content.message']").change(function() {
            $(".message-preview .message").html($(this).val().replace("\n", "<br/>"));
        });
        
       function removeFile(uuid) {
            data = new FormData();
            data.append("_csrf", /*[[${_csrf.token}]]*/ "");
            $.ajax({
                data: data,
                type: "POST",
                /*[+
                url: [[@{'/fileremovebyuuid/'}]] + uuid ,
                +]*/
                cache: false,
                contentType: false,
                processData: false,
                success: function(response, status, xhr) {
                    console.log('File '+uuid+'Removed - ', status)
                }
            });
        }

        function handleFiles() {
            if (/*[[${deliverable.id == null}]]*/ ) {  // Creation, no files
                console.log('No File(s) to handle ');
                newFiles = new Array();
                removedFiles = new Array();
                formSubmit();
                return;
            }

            data = new FormData();
            var _i;
            for ( _i = 0; _i < newFiles.length; _i++) {
                data.append("addFile",newFiles[_i]);
            }
            for ( _i = 0; _i < removedFiles.length; _i++) {
                data.append("removeFile",removedFiles[_i]);
            }
            data.append("_csrf", /*[[${_csrf.token}]]*/ "");
            $.ajax({
                data: data,
                type: "POST",
                /*[+
                url: [[@{'/deliverypipe/' + ${deliveryPipeId} + '/' + ${deliverable.type.name().toLowerCase()} + '/' + ${deliverable.id} + '/files'}]] ,
                +]*/
                cache: false,
                contentType: false,
                processData: false,
                success: function(response, status, xhr) {
                    console.log('File(s) handling - ', status);
                    $("textarea[name='content.content']").html(response.data);
                    newFiles = new Array();
                    removedFiles = new Array();
                    formSubmit();
                },
                error: function(error) {
                    console.log('File(s) handling failed - ', error);
                    mContent.notify("Failed to save the changes", "error");
                }
            });
        }

        function formSubmit() {
            var deliveryPipeContentListUrl = /*[[@{|/deliverypipe/${deliveryPipeId}/content/list|}]]*/ "";
            mContent.ajax.submit(thisForm,
                function(data) {
                    mContent.notify("Changes stored", "info");
                    mContent.loaders.workArea(deliveryPipeContentListUrl);
                }, function(error) {
                    mContent.notify("Failed to save the changes", "error");
                }
            );
        }

        $(document).ready(function() {

            $(".remove-content-file").click(function (event) {
                event.preventDefault();
                addRemovedFile($(this).attr("href"));
                $(".previewer-content div:has(#"+$(this).attr("href")+")").remove();  //poista esikatselusta
                $(this).parents("tr").remove(); // poista taulukosta
            });

            $(".content-submit").click(function() {
                event.preventDefault();
                handleFiles();
            });

            $(".content-cancel").click(function() {
                var _i;
                for (_i = 0; _i < newFiles.length; _i++) {  // remove newly added files from server
                    removeFile(newFiles[_i]);
                }
                $('#content-editor').html( "" );  // clear content form
            });

        });

        /*]]>*/
    </script>
</div>