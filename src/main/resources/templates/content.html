<div class="content" th:unless="${#lists.isEmpty(deliverable)}">


    <script th:src="@{|/lib/dropzone/dropzone.js|}"></script>
    <formfield>
        <legend>Basic info</legend>
        <div th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.SeriesDeliverable)}" th:text="@{|Delivery position: ${deliverable.deliveryDaysAfterSubscription}|}"></div>
        <div th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.ScheduledDeliverable)}" th:text="@{|Delivery date: ${deliverable.getDeliveryDateString()}|}"></div>
        <a th:href="${deliverable.content.getContentUrl()}" target='_blank'>Link</a>
    </formfield>
    <formfield>
        <legend>Content</legend>
        <form name="content-form" class="pure-form pure-form-stacked" action="#" th:action="@{/deliverypipe/} + ${deliveryPipeId} + '/' + ${deliverable.type.name().toLowerCase()} + '/' + ${deliverable.id}"
              method="post" enctype="multipart/form-data">
            <div class="form-fields">
                <div th:if="${error}" class="alert alert-error" th:text="#{deliverable.error}">
                    Error in content data.
                </div>
                <div th:if="${saved}" class="alert alert-success" th:text="#{deliverable.saved}">
                    Content saved.
                </div>
                <input type="hidden" name="id" th:value="${deliverable.id}"/>

                <input type="hidden" th:name="content.id" th:value="${deliverable.content.id}"/>
                <input type="hidden" th:name="status" th:value="${deliverable.status}"/>

                <!-- TODO: content in view mode if status == APPROVED -->

                <!--<input type="checkbox" class="pure-checkbox" th:checked="true" required="false" th:name="autoProcess" th:text="Autoload" th:value="true"/> -->
                <input type="checkbox" class="pure-checkbox" th:checked="false" required="false" th:name="debugOn" th:text="Debug" th:value="false"/>

                <label for="content.title" th:text="#{content.title}">Title</label>
                <input type="text"
                       th:if="${deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                       required="true" name="content.title" th:value="${deliverable.content.title}"/>
                <input type="text"
                       th:if="${deliverable.status == T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                       required="false" readonly="true" name="content.title" th:value="${deliverable.content.title}"/>

                <label for="content.message" th:text="#{content.message}">Title</label>
                <textarea required="true"
                          th:if="${deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                          name="content.message" th:text="${deliverable.content.message}" maxlength="140" cols="30" row="6"/>
                <textarea required="false" readonly="true"
                          th:if="${deliverable.status == T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                          name="content.message" th:text="${deliverable.content.message}" maxlength="140" cols="30" row="6"/>
                <span class="message-preview">
                    <span class="message" th:text="@{|${deliverable.content.message}|}"></span>
                    <br/>
                    <span class="url" th:text="${deliverable.content.getContentUrl()}"></span>
                </span>

                <!--    File Upload option -->
                <div id="my-dropzone" th:if="${theme == 'comics' and deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}">
                    <label th:text="#{contentfiles.files}">Files</label>
                    <table class="pure-table">
                        <tbody>
                            <tr th:each="contentFile : ${deliverable.files}">
                                <td th:text="${contentFile.originalFilename}">NAME</td>
                                <td>
                                    <div>
                                        <a class="remove-content-file pure-button" sec:authorize="hasRole('ADMIN')" 
                                           th:href="@{/deliverypipe/} + ${deliveryPipeId} + '/' + ${deliverable.type.name().toLowerCase()} + '/' + ${deliverable.id} + '/fileremove/' + ${contentFile.id}"
                                           th:text="#{general.remove}" >Remove</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <br/>
                    <label th:text="#{contentfiles.dropzone.tip}">Drop new files here or click this area</label>
                    <div id="dropzone-previews" class="dropzone-previews dropzone dz-clickable dz-default dz-message">
                        <div class="fallback">
                            <input type="file" name="file" multiple="multiple"/>
                        </div>
                    </div>
                    <br/>
                    <input type="hidden" required="false" name="content.content" th:text="${deliverable.content.content}"/>
                </div>
                <div th:unless="${theme == 'comics' and deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}">
                    <label for="content.content" th:text="#{content.content}">Content</label>
                    <textarea required="true"
                              th:if="${deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                              name="content.content" th:text="${deliverable.content.content}"/>
                    <textarea required="false" readonly="true"
                              th:if="${deliverable.status == T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                              name="content.content" th:text="${deliverable.content.content}"/>
                </div>

                <input type="hidden" th:name="save" />
                <input th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.SeriesDeliverable)}" type="hidden" th:name="deliveryDaysAfterSubscription" th:value="${deliverable.deliveryDaysAfterSubscription}"/>
                <input th:if="${deliverable instanceof T(com.mnewservice.mcontent.domain.ScheduledDeliverable)}" type="hidden" th:name="deliveryDate" th:field="${deliverable.deliveryDateString}"/>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            </div>
            <br/>
            <div class="form-actions">
                <a class="submit pure-button" 
                   th:if="${deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}"
                   th:text="#{general.save}">Save</a>
                <a class="cancel pure-button" th:text="#{general.cancel}">Cancel</a>
            </div>
        </form>
    </formfield>
    <div id="previewers">
        <div class="iphone-previewer">
            <div class="previewer-content" th:utext="${deliverable.content.content}"></div>
        </div>
        <div class="ipad-previewer">
            <div class="previewer-content" th:utext="${deliverable.content.content}"></div>
        </div>
    </div>

    <script th:inline="javascript" th:if="${theme == 'comics' and deliverable.status != T(com.mnewservice.mcontent.domain.DeliverableStatus).APPROVED}" >
        /*<![CDATA[*/
        var fileDropzone = new Dropzone("div#my-dropzone", {
            /*[+
            url: [[@{'/deliverypipe/' + ${deliveryPipeId} + '/' + ${deliverable.type.name().toLowerCase()} + '/' + ${deliverable.id} + '/fileupload'}]],
            +]*/
            autoProcessQueue: true,
            uploadMultiple: false, // Multiple ei toimi kunnolla virhetilanteessa, koska flagaa kaikki virheellisiksi
            createImageThumbnails: true,
            parallelUploads: 20,
            maxFiles: 20,
            maxFilesize: 2, // Max file size 2MB
            filesizeBase: 1024,
            acceptedFiles: 'image/*',
            previewsContainer: '#dropzone-previews',
            init: function () {
                var myDropzone = this;

                //document.querySelector("[name='autoProcess']").addEventListener("click", function (e) {
                //    myDropzone.options.autoProcessQueue = $("[name='autoProcess']").prop("checked");
                //});

                this.on("processing", function (file) {
                    if ($("[name='debugOn']").prop("checked")) mContent.notify("processing - event", "info");
                 });

                 this.on("addedfile", function (file) {
                    if ($("[name='debugOn']").prop("checked")) mContent.notify("addedfile - event", "info");
                    // Check for duplicates
                    var _file, _i, _len, _ref, _result;
                    _ref = this.files;
                    _result = 0;
                    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                        _file = _ref[_i];
                        if ((_file.name === file.name) && (_file.size === file.size)) {
                            _result++;
                        }
                    }
                    if (_result > 1) {  // No duplicates thank you
                        this.removeFile(file);
                        mContent.notify("Can not add file ("+file.name+")\nFile is allready uploaded", "error");
                    }
                });

                this.on("success", function (file, response) {
                    if ($("[name='debugOn']").prop("checked"))  mContent.notify("success - event : "+file.name, "info");
                });

                this.on("error", function (file, response, xhr) {
                    var _filename = file.name;
                    if ($("[name='debugOn']").prop("checked"))  mContent.notify("error - event : "+_filename, "info");
                    mContent.notify("Error on uploading file "+_filename+"\nResponse message: "+response.message ,"error");
                    var removeButton = Dropzone.createElement("<button>Clear</button>");
                    var _this = this;
                    removeButton.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        // Remove the file preview.
                        _this.removeFile(file);
                        // Remove from server

                    });
                    file.previewElement.appendChild(removeButton);
                });

                this.on("removedfile", function (file) {
                    // Gets triggered when the file have successfully been sent.
                    // Redirect user or notify of success.
                    if ($("[name='debugOn']").prop("checked"))  mContent.notify("removedfile - event : "+file.name, "info");

                    if (file.status === Dropzone.SUCCESS) {
                        // Tiedosto löytyy palvelimelta
                    }
                });

                this.on("complete", function (file) {
                    // Gets triggered when the file have successfully been sent.
                    // Redirect user or notify of success.
                    if ($("[name='debugOn']").prop("checked"))  mContent.notify("complete - event : "+file.name, "info");

                });

                this.on("sending", function(file, xhr, formData) {
                    // Will send the filesize along with the file as POST data.
                    // mContent.notify("sending - event", "info");
                    formData.append("_csrf", /*[[${_csrf.token}]]*/);

                    if ($("[name='debugOn']").prop("checked"))  mContent.notify("sending - event : "+file.name, "info");
                });

                // Load existing files to Dropzone
            }
        });
        /*]]>*/
    </script>

    <script th:inline="javascript">

        //$("select[name='providers']").multiSelect();
        $("textarea[name='content.content']").summernote({
            onChange: function (e) {
                $(".previewer-content").html($("textarea[name='content.content']").code());
            }
        });
        $("input[name='content.title']").change(function() {
            if(!$("textarea[name='content.message']").val()) {
                $("textarea[name='content.message']").val($(this).val() + "\n\nClick for more");
            }
        });
        $("textarea[name='content.message']").change(function() {
            $(".message-preview .message").html($(this).val().replace("\n", "<br/>"));
        });
        $(".remove-content-file").click(function (event) {
            var deliveryPipeContentUrl = /*[[@{'/deliverypipe/' + ${deliveryPipeId} + '/' + ${deliverable.type.name().toLowerCase()} + '/' + ${deliverable.id}}]]*/;
            event.preventDefault();
            mContent.ajax.submitUrl($(this).parents("form"), $(this).attr("href"),
                    function (data) {
                        mContent.notify("Remove successful", "info");
                        mContent.loaders.contentEditor(deliveryPipeContentUrl);
                    },
                    function (error) {
                        mContent.notify("Remove of file failed", "error");
                    }
            );
            return false;
        });
        $(".submit").click(function() {
            var deliveryPipeContentListUrl = /*[[@{|/deliverypipe/${deliveryPipeId}/content/list|}]]*/;
            event.preventDefault();
            mContent.ajax.submit($(this).parents('form'),
                function(data) {
                    mContent.notify("Changes stored", "info");
                    mContent.loaders.workArea(deliveryPipeContentListUrl);
                }, function(error) {
                    console.log(error);
                    mContent.notify("Failed to save the changes", "error");
                }
            );
        })
        $(".cancel").click(function() {
            $('#content-editor').html( "" );
        })
    </script>
</div>